"""websocket长连接程序
"""
import json

import websocket

from utils import queue_manager
from security_platform import receive_logger as logger

try:
    import thread
except ImportError:
    import _thread as thread

ws_queue = queue_manager.Queue()


def on_message(_, message):
    """收到消息回调函数"""
    print(message)


def on_error(_, error):
    """发送异常回调函数"""
    print(error)


def on_close(_):
    """连接关闭回调函数"""
    logger.error('websocket 连接断开')


def on_open(ws):
    """连接成功后运行的函数

    连接成功后开启子线程运行run函数
    run函数负责从ws_queue队列中获取数据然后发送给服务器，如果没有数据就一直阻塞

    Args:
        ws: websocket的连接对象
    """
    def run():
        while True:
            msg = ws_queue.get()
            # logger.info('发送ws消息:%s', msg)
            ws.send(json.dumps(msg))

    thread.start_new_thread(run, ())


def ws_run_forever(host):
    """开启websocket长连接

    Args:
        host: websocket连接地址
    """
    websocket.enableTrace(True)
    ws = websocket.WebSocketApp(host, on_open=on_open, on_error=on_error, on_close=on_close)
    ws.run_forever(ping_interval=60, ping_timeout=5)
