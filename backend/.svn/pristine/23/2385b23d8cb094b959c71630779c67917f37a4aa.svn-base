from django_filters.rest_framework import DjangoFilterBackend

from security_platform.utils.exceptions import ParamError


class CustomDjangoFilterBackend(DjangoFilterBackend):
    """自定义后端过滤器"""

    def error_process(self, error_dict):
        for key, error_list in error_dict.as_data().items():
            raise ParamError(errmsg=error_list[0].messages[0])

    def filter_queryset(self, request, queryset, view):
        filterset = self.get_filterset(request, queryset, view)
        if filterset is None:
            return queryset

        if not filterset.is_valid() and self.raise_exception:
            self.error_process(filterset.errors)

        return filterset.qs
