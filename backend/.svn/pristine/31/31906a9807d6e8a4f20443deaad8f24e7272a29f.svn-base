"""
工厂类
"""
import os
import configparser

from enums import ServerNameEnum
from database import DatabaseManager
from command import DjangoCommandExecute
from server import ApiServer, MqReceiveServer, WebsocketServer, ELKServer

file_path = os.path.abspath(__file__)
file_format = os.path.splitext(file_path)[-1]
base_dir = os.path.dirname(os.path.dirname(file_path))
elk_base_dir = os.path.dirname(base_dir)
config_file_path = os.path.join(base_dir, 'security_platform/config.ini')

config_parser = configparser.ConfigParser()
config_parser.read(config_file_path)


class Factory:
    """抽象工厂类"""

    def create_object(self, param_value):
        """创建对象"""
        raise NotImplementedError('create_object must be implemented')


class DatabaseManagerFactory(Factory):
    """数据库工厂类"""

    def create_object(self, param_value):
        return DatabaseManager(config_parser.get('MYSQL', 'MYSQL_HOST'),
                               int(config_parser.get('MYSQL', 'MYSQL_PORT')),
                               param_value)


class DjangoCommandExecuteFactory(Factory):
    """django命令工厂类"""

    def create_object(self, param_value):
        return DjangoCommandExecute(os.path.join(base_dir, f'security_platform/manage{file_format}'))


class ServerFactory(Factory):
    """服务工厂类"""

    def create_object(self, param_value):
        if param_value == ServerNameEnum.API_SERVER_NAME.value:
            obj = ApiServer(config_file_path)
        elif param_value == ServerNameEnum.MQ_SERVER_NAME.value:
            obj = MqReceiveServer(os.path.join(base_dir, f'security_platform/mqtt_receive/main{file_format}'))
        elif param_value == ServerNameEnum.WS_SERVER_NAME.value:
            obj = WebsocketServer(os.path.join(base_dir, f'websocket_server/mysite/manage{file_format}'))
        elif param_value == ServerNameEnum.elk_server_name.value:
            obj = ELKServer(os.path.join(elk_base_dir, f'ELK/scripts/elk.sh'))
        else:
            raise TypeError(f'不存在的服务名称:{param_value}')

        return obj
