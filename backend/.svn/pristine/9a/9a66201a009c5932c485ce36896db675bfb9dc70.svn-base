"""
报警超过30分钟已上且无工单的自动上报事件，进行自动关闭该事件
"""
from datetime import datetime, timedelta

from django_setup import logger, SystemConfig, connection, event_model


def close_expire_event():
    """
    0.自动上报
    1.状态待处置
    2.创建时间在30分钟以上
    3.无工单流程
    设置工单状态为已解除
    """
    diff_hours = SystemConfig.objects.get(config_key=SystemConfig.ConfigKey.EVENT_CLOSE).config_value
    latest_time = datetime.now() - timedelta(hours=int(diff_hours))

    execute_sql = f"""
        update tb_basic_alarm_event set event_state='{event_model.DeviceAlarmEvent.EventState.RELIEVED}' where id in (
            select ret.id from (
                select event.id from tb_basic_alarm_event event left join tb_event_work_sheet as sheet 
                on sheet.alarm_event_id=event.id 
                where event.event_type={event_model.AlarmEvent.EventType.DEVICE} 
                and event.event_state='{event_model.DeviceAlarmEvent.EventState.UNDISPOSED}'
                and event.create_time < '{latest_time}'
                and sheet.id is null
            ) ret 
        );
    """

    with connection.cursor() as cursor:
        update_count = cursor.execute(execute_sql)
        if update_count:
            logger.info('关闭报警事件%s个', update_count)


if __name__ == '__main__':
    close_expire_event()
