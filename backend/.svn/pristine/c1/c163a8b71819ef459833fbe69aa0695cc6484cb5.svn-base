"""子系统的设备相关消息业务逻辑处理

GenericDeviceResource 通用的设备新增，设备删除，设备修改，设备状态变更业务处理
各系统子类可重写对应的函数来重写或修改业务逻辑
"""
import datetime
from collections import OrderedDict

from devices import models
from security_platform.utils.commen import blank_get

from core.generics import CommonLabelResource
from utils.exceptions import NoProcessingError


class GenericDeviceResource(CommonLabelResource):
    """设备消息处理

    Class Attributes:
        model_class: 设备对应的模型类对象，用于数据库对象操作
        device_type: 设备所属设备类型，根据设备类型的枚举类定义，用于获取设备类型字段
        system_code: 设备所属系统编码，根据系统编码的枚举类定义，用于获取设备系统类型字段
    """

    model_class = models.DeviceInfo
    device_type = None

    def get_device_type(self):
        assert self.device_type is not None, (
            "'%s' should either include a `device_type` attribute, "
            "or override the `get_device_type()` method." % self.__class__.__name__)
        return self.device_type

    def get_state_label(self):
        """设备状态变更，数据标签设置"""
        self.validate_enum_filed(
            'device_state',
            [models.DeviceInfo.DeviceState.NORMAL, models.DeviceInfo.DeviceState.TROUBLE_OPEN],
            integer=False
        )

        label = OrderedDict()
        label['device_state'] = self.label['device_state']

        if self.label['device_state'] == self.model_class.DeviceState.TROUBLE_OPEN:
            label['trouble_code'] = self.label.get('error_code', '0')
            label['trouble_message'] = self.label.get('error_message', '未知故障')
            label['trouble_time'] = datetime.datetime.now()

        return label

    def get_create_or_update_label(self):
        label = self.get_state_label()
        label['device_name'] = self.label['device_name']
        label['device_code'] = self.label['device_code']
        label['device_type_id'] = blank_get(self.label, 'device_type_id')
        label['device_type_name'] = blank_get(self.label, 'device_type_name')
        label['ipv4'] = blank_get(self.label, 'ip')
        label['port'] = blank_get(self.label, 'port')
        label['switches'] = blank_get(self.label, 'switches')
        label['area_code'] = blank_get(self.label, 'area_code')
        label['floor_code'] = blank_get(self.label, 'floor_code')
        label['manufacturer'] = blank_get(self.label, 'manufacturer_code')
        label['device_model'] = blank_get(self.label, 'device_model')
        label['related_camera_code'] = blank_get(self.label, 'related_camera_code')
        label['device_type_id_son'] = blank_get(self.label, 'device_type_id_son')
        label['device_cad_code'] = blank_get(self.label, 'device_cad_code')
        label['device_type'] = self.get_device_type()
        label['belong_system'] = self.get_system_code()

        return label

    def get_create_label(self):
        return self.get_create_or_update_label()

    def get_update_label(self):
        return self.get_create_or_update_label()

    def get_sync_label(self):
        return self.get_create_or_update_label()

    def get_object_label(self):
        return {'device_code': self.label['device_code']}


class CameraDeviceResource(GenericDeviceResource):
    """摄像机设备事件"""

    model_class = models.CameraDevice
    device_type = model_class.DeviceType.CAMERA
    system_code = model_class.BelongSystem.CAMERA

    def validate_device_type(self):
        """排除非摄像机类型的设备"""
        if self.label['device_type_name'] != 'Camera':
            raise NoProcessingError(f"不处理的设备类型:{self.label['device_type_name']}")

    def is_config_camera_info(self, camera_split_list):
        if len(camera_split_list) != 3:
            return False

        if camera_split_list[1] not in ['枪击', '球机', '全景']:
            return False

        return True

    def get_create_or_update_label(self):
        """默认的数据标签设置

        设备新增和设备更新时添加额外字段
        """
        self.validate_device_type()

        label = super().get_create_or_update_label()
        label['is_ptz'] = self.label['ptz'] == 'Yes'
        label['flow_address'] = self.label['rtsp']

        # 设备格式示例：C6-18-2 枪机 192.168.21.185
        camera_split_list = self.label['device_name'].split(' ')
        if self.is_config_camera_info(camera_split_list):
            # 设备点位信息分割
            label['area_code'] = camera_split_list[0]
            label['camera_type'] = camera_split_list[1]

        return label


class MaintenanceDeviceResource(GenericDeviceResource):
    """围界设备事件处理"""

    model_class = models.MaintenanceDevice
    device_type = model_class.DeviceType.MAINTENANCE
    system_code = model_class.BelongSystem.MAINTENANCE


class EntranceDeviceResource(GenericDeviceResource):
    """门禁设备事件处理"""

    model_class = models.EntranceDevice
    device_type = model_class.DeviceType.ENTRANCE
    system_code = model_class.BelongSystem.ENTRANCE


class FireDeviceResource(GenericDeviceResource):
    """消防设备事件处理"""

    model_class = models.FireDevice
    device_type = model_class.DeviceType.FIRE
    system_code = model_class.BelongSystem.FIRE


class ConcealDeviceResource(GenericDeviceResource):
    """隐蔽报警设备事件处理"""

    model_class = models.ConcealAlarmDevice
    device_type = model_class.DeviceType.CONCEAL
    system_code = model_class.BelongSystem.CONCEAL


class PassageWayDeviceResource(GenericDeviceResource):
    """道口设备事件处理"""

    model_class = models.PassageWayDevice
    device_type = model_class.DeviceType.PASSAGE
    system_code = model_class.BelongSystem.PASSAGE
